<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatter Up</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div class="bg-container">
      <header class="header">
        <div class="headings">
          <h1>Chatter Up</h1>
          <h3>Chat with friends</h3>
        </div>
        <div id="welcome-message">
          <!-- here goes welcome message -->
        </div>
      </header>
      <div class="main-bg-container">
        <main class="main-container">
          <section class="chat-container">
            <ul class="messages-container">
              <!-- messages goes here -->
            </ul>
          </section>
          <section class="form-container">
            <form id="chat-form">
              <input type="text" id="input" />
              <button class="send-btn" type="submit">Send</button>
            </form>
          </section>
        </main>
        <aside class="users-container">
          <ul class="users-list">
            <li id="users-list-header">Connected Users 3</li>
          </ul>
        </aside>
      </div>
    </div>
    <!-- importing socket -->
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
      // connecting to socket
      const socket = io.connect("http://localhost:3000/");

      // elements
      const welcomeMessageEl = document.querySelector("#welcome-message");
      const messageContainerEl = document.querySelector(".messages-container");
      const formEl = document.querySelector("#chat-form");
      const inputEl = document.querySelector("#input");
      const connectedUsersContainerEl = document.querySelector(".users-list");

      // variables
      let userName = "";
      let message = "";

      // to set the time since message sent
      const getTimeSinceMessage = (date) => {
        const lapseTimeInMilSec = Date.now() - date.valueOf();
        let seconds = (lapseTimeInMilSec / 1000).toFixed(0);
        let minutes = Math.floor(seconds / 60);
        let hours = "";
        if (minutes > 59) {
          hours = Math.floor(minutes / 60);
          hours = hours >= 10 ? hours : "0" + hours;
          minutes = minutes - hours * 60;
          minutes = minutes >= 10 ? minutes : "0" + minutes;
        }

        seconds = Math.floor(seconds % 60);
        seconds = seconds >= 10 ? seconds : "0" + seconds;
        if (hours != "") {
          return hours + ":" + minutes + ":" + seconds;
        }
        return minutes + ":" + seconds;
      };

      // to create message threads dynamically
      const createMessageThread = (messageData) => {
        // create element
        const messageEl = document.createElement("li");
        const profileEl = document.createElement("img");
        const messageDataEl = document.createElement("div");
        const messageHeaderEl = document.createElement("div");
        const userNameEl = document.createElement("span");
        const timeEl = document.createElement("span");
        const messageContentEl = document.createElement("p");

        profileEl.src = `${messageData.profilePicUrl}`;
        profileEl.alt = `${messageData.userName}`;
        profileEl.classList.add("profile-icon");

        userNameEl.textContent = `${messageData.userName}`;
        userNameEl.classList.add("user-name");

        const date = new Date(messageData.timestamp);
        const lapseTime = getTimeSinceMessage(date);
        timeEl.textContent = lapseTime;
        timeEl.classList.add("time");

        messageHeaderEl.appendChild(userNameEl);
        messageHeaderEl.appendChild(timeEl);
        messageHeaderEl.classList.add("message-thread-header");

        messageContentEl.textContent = messageData.message;
        messageContentEl.classList.add("message-content");

        messageDataEl.appendChild(messageHeaderEl);
        messageDataEl.appendChild(messageContentEl);
        messageDataEl.classList.add("message-data-container");

        messageEl.appendChild(profileEl);
        messageEl.appendChild(messageDataEl);

        // keep user messages to the right by userName condition
        if (userName === messageData.userName) {
          messageDataEl.classList.add("self-message-data-container");
          profileEl.classList.add("icon-margin-left");
          messageEl.classList.add("self-message");
        } else {
          profileEl.classList.add("icon-margin-right");
          messageEl.classList.add("message-thread");
        }

        messageContainerEl.appendChild(messageEl);
      };

      const createConnectedUser = (user) => {
        const userEl = document.createElement("li");
        userEl.innerHTML = `<div class="indicator"></div>${user}`;
        connectedUsersContainerEl.appendChild(userEl);
      };

      const createConnectedUsersList = (users) => {
        // creating users list
        users.forEach((user) => {
          createConnectedUser(user);
        });
      };

      // on document load
      document.addEventListener("DOMContentLoaded", () => {
        // taking user name
        userName = prompt("Please enter your name!");

        // emitting user join event
        socket.emit("join", userName);

        // listening for the welcome event
        socket.on("welcome", (data) => {
          const { message, chatHistory } = data;

          // append message to element
          welcomeMessageEl.innerHTML =
            "<div class='indicator'></div> <h3>" + message + "</h3>";

          // append chat history to the chat container
          chatHistory.map((message) => {
            createMessageThread(message);
          });

          // getting users
          const usersArr = chatHistory.map((chat) => chat.userName);
          const usersSet = new Set(usersArr);
          createConnectedUsersList(usersSet);
        });
      });

      // on message
      formEl.addEventListener("submit", (event) => {
        event.preventDefault();

        // set message
        if (inputEl.value) {
          message = inputEl.value;
        }

        // emit messageSend event
        socket.emit("messageSend", { userName, message });

        // clearing the input
        inputEl.value = "";
      });

      socket.on("message", (messageData) => {
        createMessageThread(messageData);
      });

      socket.on("newMember", (newUser) => {
        createConnectedUser(newUser);
        if (newUser === userName) {
          return;
        }
        const notifyEl = document.createElement("div");
        notifyEl.style.display = "flex";
        notifyEl.style.justifyContent = "center";
        const notifyMessageEl = document.createElement("p");
        notifyMessageEl.textContent = `${newUser} has joined`;
        notifyMessageEl.classList.add("notify");
        notifyEl.appendChild(notifyMessageEl);
        messageContainerEl.appendChild(notifyEl);
      });
    </script>
  </body>
</html>
